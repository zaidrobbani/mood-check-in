// TODO break the function into small parts to create custom hooks